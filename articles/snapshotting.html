<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snapshot tests • testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Snapshot tests">
<meta property="og:description" content="testthat">
<meta property="og:image" content="https://testthat.r-lib.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testthat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.4.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/custom-expectation.html">Custom expectations</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running tests in parallel</a>
    </li>
    <li>
      <a href="../articles/skipping.html">Skipping tests</a>
    </li>
    <li>
      <a href="../articles/snapshotting.html">Snapshot tests</a>
    </li>
    <li>
      <a href="../articles/test-fixtures.html">Test fixtures</a>
    </li>
    <li>
      <a href="../articles/third-edition.html">testthat 3e</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/testthat/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="snapshotting_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Snapshot tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/master/vignettes/snapshotting.Rmd"><code>vignettes/snapshotting.Rmd</code></a></small>
      <div class="hidden name"><code>snapshotting.Rmd</code></div>

    </div>

    
    
<p>The goal of a unit test is to record the expected output of a function using code. This is a powerful technique because not only does it ensure that code doesn’t change unexpectedly, it also expresses the desired behaviour in a way that a human can understand.</p>
<p>However, it’s not always convenient to record the expected behaviour with code. Some challenges include:</p>
<ul>
<li><p>Text output that includes many characters like quotes and newlines that require special handling in a string.</p></li>
<li><p>Output that is large, making it painful to define the reference output, and bloating the size of the test file and making it hard to navigate.</p></li>
<li><p>Binary formats like plots or images, which are very difficult to describe in code: i.e. the plot looks right, the error message is useful to a human, the print method uses colour effectively.</p></li>
</ul>
<p>For these situations, testthat provides an alternative mechanism: snapshot tests. Instead of using code to describe expected output, snapshot tests (also known as <a href="https://ro-che.info/articles/2017-12-04-golden-tests">golden tests</a>) record results in a separate human readable file. Snapshot tests in testthat are inspired primarily by <a href="https://jestjs.io/docs/en/snapshot-testing">Jest</a>, thanks to a number of very useful discussions with Joe Cheng.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></code></pre></div>
<div id="basic-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-workflow" class="anchor"></a>Basic workflow</h2>
<p>We’ll illustrate the basic workflow with a simple function that generates an HTML heading. It can optionally include an <code>id</code> attribute, which allows you to construct a link directly to that heading.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bullets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"&lt;ul"</span>, <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">" id=\""</span>, <span class="va">id</span>, <span class="st">"\""</span><span class="op">)</span>, <span class="st">"&gt;\n"</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"  &lt;li&gt;"</span>, <span class="va">text</span>, <span class="st">"&lt;/li&gt;\n"</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
    <span class="st">"&lt;/ul&gt;\n"</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, id <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;ul id="x"&gt;</span>
<span class="co">#&gt;   &lt;li&gt;a&lt;/li&gt;</span>
<span class="co">#&gt; &lt;/ul&gt;</span></code></pre></div>
<p>Testing this simple function is relatively painful. To write the test you have to carefully escape the newlines and quotes. And then when you re-read the test in the future, all that escaping makes it hard to tell exactly what it’s supposed to return.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>, <span class="st">"&lt;ul&gt;\n  &lt;li&gt;a&lt;/li&gt;\n&lt;/ul&gt;\n"</span><span class="op">)</span>
  <span class="fu"><a href="../reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, id <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>, <span class="st">"&lt;ul id=\"x\"&gt;\n  &lt;li&gt;a&lt;/li&gt;\n&lt;/ul&gt;\n"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed 🥇</span></code></pre></div>
<p>This is a great place to use snapshot testing. To do this we make two changes to our code:</p>
<ul>
<li><p>We use <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> instead of <code><a href="../reference/equality-expectations.html">expect_equal()</a></code></p></li>
<li><p>We wrap the call in <code><a href="https://rdrr.io/r/base/cat.html">cat()</a></code> (to avoid <code>[1]</code> in the output, like in my first interactive example).</p></li>
</ul>
<p>This yields the following test:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; ── Warning (&lt;text&gt;:2:3): bullets ───────────────────────────────────────────────</span>
<span class="co">#&gt; Adding new snapshot:</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   cat(bullets("a"))</span>
<span class="co">#&gt; Output</span>
<span class="co">#&gt;   &lt;ul&gt;</span>
<span class="co">#&gt;     &lt;li&gt;a&lt;/li&gt;</span>
<span class="co">#&gt;   &lt;/ul&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Warning (&lt;text&gt;:3:3): bullets ───────────────────────────────────────────────</span>
<span class="co">#&gt; Adding new snapshot:</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   cat(bullets("a", "b"))</span>
<span class="co">#&gt; Output</span>
<span class="co">#&gt;   &lt;ul id="b"&gt;</span>
<span class="co">#&gt;     &lt;li&gt;a&lt;/li&gt;</span>
<span class="co">#&gt;   &lt;/ul&gt;</span></code></pre></div>
<p>When we run the test for the first time, it automatically generates reference output, and prints it, so that you can visually confirm that it’s correct. The output is automatically saved in <code>_snaps/{name}.R</code>. The name of the snapshot matches your test file name — e.g. if your test is <code>test-pizza.R</code> then your snapshot will be saved in <code>test/testthat/_snaps/pizza.md</code>. As the file name suggests, this is a markdown file, which I’ll explain shortly.</p>
<p>If you run the test again, it’ll succeed:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed 🎊</span></code></pre></div>
<p>But if you change the underlying code, say to tweak the indenting, the test will fail:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bullets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"&lt;ul"</span>, <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">" id=\""</span>, <span class="va">id</span>, <span class="st">"\""</span><span class="op">)</span>, <span class="st">"&gt;\n"</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;li&gt;"</span>, <span class="va">text</span>, <span class="st">"&lt;/li&gt;\n"</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
    <span class="st">"&lt;/ul&gt;\n"</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"bullets"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">bullets</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; ── Failure (&lt;text&gt;:9:3): bullets ───────────────────────────────────────────────</span>
<span class="co">#&gt; Snapshot of code has changed:</span>
<span class="co">#&gt; `old[2:6]`: "  cat(bullets(\"a\"))" "Output" "  &lt;ul&gt;" "    &lt;li&gt;a&lt;/li&gt;" "  &lt;/ul&gt;"</span>
<span class="co">#&gt; `new[2:6]`: "  cat(bullets(\"a\"))" "Output" "  &lt;ul&gt;" "  &lt;li&gt;a&lt;/li&gt;"   "  &lt;/ul&gt;"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Run `snapshot_accept('snapshotting.Rmd')` if this is a deliberate change</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Failure (&lt;text&gt;:10:3): bullets ──────────────────────────────────────────────</span>
<span class="co">#&gt; Snapshot of code has changed:</span>
<span class="co">#&gt;     old                            | new                               </span>
<span class="co">#&gt; [2] "  cat(bullets(\"a\", \"b\"))" | "  cat(bullets(\"a\", \"b\"))" [2]</span>
<span class="co">#&gt; [3] "Output"                       | "Output"                       [3]</span>
<span class="co">#&gt; [4] "  &lt;ul id=\"b\"&gt;"              | "  &lt;ul id=\"b\"&gt;"              [4]</span>
<span class="co">#&gt; [5] "    &lt;li&gt;a&lt;/li&gt;"               - "  &lt;li&gt;a&lt;/li&gt;"                 [5]</span>
<span class="co">#&gt; [6] "  &lt;/ul&gt;"                      | "  &lt;/ul&gt;"                      [6]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Run `snapshot_accept('snapshotting.Rmd')` if this is a deliberate change</span></code></pre></div>
<p>If this is a deliberate change, you can follow the advice in the message and update the snapshots for that file by running <code><a href="../reference/snapshot_accept.html">snapshot_accept("pizza")</a></code>; otherwise you can fix the bug and your tests will pass once more. (You can also accept snapshot for all files with <code><a href="../reference/snapshot_accept.html">snapshot_accept()</a></code>).</p>
<div id="snapshot-format" class="section level3">
<h3 class="hasAnchor">
<a href="#snapshot-format" class="anchor"></a>Snapshot format</h3>
<p>Snapshots are recorded using a subset of markdown. You might wonder why we use markdown? It’s important that snapshots be readable by humans, because humans have to look at it during code reviews. Reviewers often don’t run your code but still want to understand the changes.</p>
<p>Here’s the snapshot file generated by the test above:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode md"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu"># bullets</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="bn">    &lt;ul&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="bn">      &lt;li&gt;a&lt;/li&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="bn">    &lt;/ul&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  </span>
<span id="cb7-7"><a href="#cb7-7"></a>---</span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="bn">    &lt;ul id="x"&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="bn">      &lt;li&gt;a&lt;/li&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="bn">    &lt;/ul&gt;</span></span></code></pre></div>
<p>Each test starts with <code># {test name}</code>, a level 1 heading. Within a test, each snapshot expectation is indented by four spaces, i.e. as code, and are separated by <code>---</code>, a horizontal rule.</p>
</div>
<div id="interactive-usage" class="section level3">
<h3 class="hasAnchor">
<a href="#interactive-usage" class="anchor"></a>Interactive usage</h3>
<p>Because the snapshot output uses the name of the current test file and the current test, snapshot expectations don’t really work when run interactively at the console. Since they can’t automatically find the reference output, they instead just print the current value for manual inspection.</p>
</div>
</div>
<div id="other-types-of-output" class="section level2">
<h2 class="hasAnchor">
<a href="#other-types-of-output" class="anchor"></a>Other types of output</h2>
<p>So far we’ve focussed on snapshot tests for output printed to the console. But <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> also captures messages, errors, and warnings. The following function generates a some output, a message, and a warning:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Hello"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Hi!"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"How are you?"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>And <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> captures them all:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"f() makes lots of noice"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; ── Warning (&lt;text&gt;:2:3): f() makes lots of noice ───────────────────────────────</span>
<span class="co">#&gt; Adding new snapshot:</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   f()</span>
<span class="co">#&gt; Output</span>
<span class="co">#&gt;   [1] "Hello"</span>
<span class="co">#&gt; Message &lt;simpleMessage&gt;</span>
<span class="co">#&gt;   Hi!</span>
<span class="co">#&gt; Warning &lt;simpleWarning&gt;</span>
<span class="co">#&gt;   How are you?</span></code></pre></div>
<p>Capturing errors is <em>slightly</em> more difficult because <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> will fail when there’s an error:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add a number and a letter"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; ── Error (&lt;text&gt;:2:3): you can't add a number and a letter ─────────────────────</span>
<span class="co">#&gt; Error: `1 + "a"` threw an unexpected error.</span>
<span class="co">#&gt; Message: non-numeric argument to binary operator</span>
<span class="co">#&gt; Class:   simpleError/error/condition</span></code></pre></div>
<p>This is a safety valve that ensures that you don’t accidentally write broken code. To deliberately snapshot an error, you’ll have to specifically request it with <code>error = TRUE</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add a number and a letter"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; ── Warning (&lt;text&gt;:2:3): you can't add a number and a letter ───────────────────</span>
<span class="co">#&gt; Adding new snapshot:</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   1 + "a"</span>
<span class="co">#&gt; Error &lt;simpleError&gt;</span>
<span class="co">#&gt;   non-numeric argument to binary operator</span></code></pre></div>
<p>When the code gets longer, I like to put <code>error = TRUE</code> up front so it’s a little more obvious:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"you can't add weird thngs"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span>
    <span class="fl">1</span> <span class="op">+</span> <span class="st">"a"</span>
    <span class="va">mtcars</span> <span class="op">+</span> <span class="va">iris</span>
    <span class="va">mean</span> <span class="op">+</span> <span class="va">sum</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; ── Warning (&lt;text&gt;:2:3): you can't add weird thngs ─────────────────────────────</span>
<span class="co">#&gt; Adding new snapshot:</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   1 + "a"</span>
<span class="co">#&gt; Error &lt;simpleError&gt;</span>
<span class="co">#&gt;   non-numeric argument to binary operator</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   mtcars + iris</span>
<span class="co">#&gt; Error &lt;simpleError&gt;</span>
<span class="co">#&gt;   '+' only defined for equally-sized data frames</span>
<span class="co">#&gt; Code</span>
<span class="co">#&gt;   mean + sum</span>
<span class="co">#&gt; Error &lt;simpleError&gt;</span>
<span class="co">#&gt;   non-numeric argument to binary operator</span></code></pre></div>
</div>
<div id="other-types-of-snapshot" class="section level2">
<h2 class="hasAnchor">
<a href="#other-types-of-snapshot" class="anchor"></a>Other types of snapshot</h2>
<p><code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> is the most used snapshot function because it records everything: the code you run, printed output, messages, warnings, and errors. But sometimes you just want to capture the output or errors in which you might want to use <code><a href="../reference/expect_snapshot.html">expect_snapshot_output()</a></code> or <code><a href="../reference/expect_snapshot.html">expect_snapshot_error()</a></code>.</p>
<p>Or rather than caring about side-effects, you may want to check that the value of an R object stays the same. In this case, you can use <code><a href="../reference/expect_snapshot.html">expect_snapshot_value()</a></code> which offers a number of serialisation approaches that provide a tradeoff between accuracy and human readability.</p>
</div>
<div id="whole-file-snapshotting" class="section level2">
<h2 class="hasAnchor">
<a href="#whole-file-snapshotting" class="anchor"></a>Whole file snapshotting</h2>
<p><code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code>, <code><a href="../reference/expect_snapshot.html">expect_snapshot_output()</a></code>, <code><a href="../reference/expect_snapshot.html">expect_snapshot_error()</a></code>, and <code><a href="../reference/expect_snapshot.html">expect_snapshot_value()</a></code> all store their snapshots in a single file per test. But that doesn’t work for all file types — for example, what happens if you want to snapshot an image? <code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> provides an alternative workflow that generates one snapshot per expectation, rather than one file per test. Assuming you’re in <code>test-burger.R</code> then the snapshot created by <code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file(code_that_returns_path_to_file(), "toppings.png")</a></code> would be saved in <code>tests/testthat/_snaps/burger/toppings.png</code>. If a future change in the code creates a different file it will be saved in <code>tests/testthat/_snaps/burger/toppings.new.png</code>.</p>
<p>Unlike <code><a href="../reference/expect_snapshot.html">expect_snapshot()</a></code> and friends, <code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> can’t provide an automatic diff when the test fails. Instead you’ll need to call <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code>. This launches a Shiny app that allows you to visually review each change and approve it if it’s deliberate:</p>
<p><img src="review-image.png"><img src="review-text.png"></p>
<p>The display varies based on the file type (currently text files, common image files, and csv files are supported).</p>
<p>Sometimes the failure occurs in a non-interactive environment where you can’t run <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code>, e.g. in <code>R CMD check</code>. In this case, the easiest fix is to retrieve the <code>.new</code> file, copy it into the appropriate directory, then run <code><a href="../reference/snapshot_accept.html">snapshot_review()</a></code> locally. If your code was run on a CI platform, you’ll need to start by downloading the run “artifact”, which contains the check folder.</p>
<p>In most cases, we don’t expect you to use <code><a href="../reference/expect_snapshot_file.html">expect_snapshot_file()</a></code> directly. Instead, you’ll use it via a wrapper that does its best to gracefully skip tests when differences in platform or package versions make it unlikely to generate perfectly reproducible output.</p>
</div>
<div id="previous-work" class="section level2">
<h2 class="hasAnchor">
<a href="#previous-work" class="anchor"></a>Previous work</h2>
<p>This is not the first time that testthat has attempted to provide snapshot testing (although it’s the first time I knew what other languages called them). This section describes some of the previous attempts and why we believe the new approach is better.</p>
<ul>
<li>
<p><code><a href="../reference/verify_output.html">verify_output()</a></code> has three main drawbacks:</p>
<ul>
<li><p>You have to supply a path where the output will be saved. This seems like a small issue, but thinking of a good name, and managing the difference between interactive and test-time paths introduces a suprising amount of friction.</p></li>
<li><p>It always overwrites the previous result; automatically assuming that the changes are correct. That means you have to use it with git and it’s easy to accidentally accept unwanted changes.</p></li>
<li><p>It’s relatively coarse grained, which means tests that use it tend to keep growing and growing.</p></li>
</ul>
</li>
<li><p><code><a href="../reference/expect_known_output.html">expect_known_output()</a></code> is finer grained version of <code><a href="../reference/verify_output.html">verify_output()</a></code> that captures output from a single function. The requirement to produce a path for each individual expectation makes it even more painful to use.</p></li>
<li><p><code><a href="../reference/expect_known_output.html">expect_known_value()</a></code> and <code><a href="../reference/expect_known_output.html">expect_known_hash()</a></code> have all the disadvantages of <code><a href="../reference/expect_known_output.html">expect_known_output()</a></code>, but also produce binary output meaning that you can’t easily review test differences in pull requests.</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
