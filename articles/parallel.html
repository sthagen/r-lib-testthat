<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running tests in parallel • testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running tests in parallel">
<meta property="og:description" content="testthat">
<meta property="og:image" content="https://testthat.r-lib.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testthat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.4.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/custom-expectation.html">Custom expectations</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running tests in parallel</a>
    </li>
    <li>
      <a href="../articles/skipping.html">Skipping tests</a>
    </li>
    <li>
      <a href="../articles/snapshotting.html">Snapshot tests</a>
    </li>
    <li>
      <a href="../articles/test-fixtures.html">Test fixtures</a>
    </li>
    <li>
      <a href="../articles/third-edition.html">testthat 3e</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/10/testthat-3-0-0/">Version 3.0.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/testthat/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="parallel_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running tests in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/master/vignettes/parallel.Rmd"><code>vignettes/parallel.Rmd</code></a></small>
      <div class="hidden name"><code>parallel.Rmd</code></div>

    </div>

    
    
<p>To take advantage of parallel tests, add the following line to the <code>DESCRIPTION</code>:</p>
<pre><code>Config/testthat/parallel: true</code></pre>
<p>You’ll also need to be using the 3rd edition:</p>
<pre><code>Config/testthat/edition: 3</code></pre>
<div id="basic-operation" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-operation" class="anchor"></a>Basic operation</h2>
<p>Starting a new R process is relatively expensive, so testthat begins by creating a pool of workers. The size of the pool will be determined by <code><a href="https://rdrr.io/r/base/options.html">getOption("Ncpus")</a></code>, then the <code>TESTTHAT_CPUS</code> envvar. If neither are set, then two processes are started. In any case, testthat will never start more subprocesses than test files.</p>
<p>Each worker begins by loading testthat and the package being tested. It then runs any setup files (so if you have existing setup files you’ll need to make sure they work when executed in parallel).</p>
<p>testthat runs test <em>files</em> in parallel. Once the worker pool is initialized, testthat then starts sending test files to workers, by default in alphabetical order: as soon as a subprocess has finished, it receives another file, until all files are done. This means that state is persisted across test files: options are <em>not</em> reset, loaded packages are <em>not</em> unloaded, the global environment is <em>not</em> cleared, etc. You are responsible for making sure each file leaves the world as it finds it.</p>
<p>Because files are run in alphabetical order, you may want to rename your slowest test files so that they start first, e.g. <code>test-1-slowest.R</code>, <code>test-2-next-slowest.R</code>, etc.</p>
</div>
<div id="common-problems" class="section level2">
<h2 class="hasAnchor">
<a href="#common-problems" class="anchor"></a>Common problems</h2>
<ul>
<li><p>If tests fail stochastically (i.e. they sometimes work and sometimes fail) you may have accidentally introduced a dependency between your test files. This sort of dependency is hard to track down due to the random nature, and you’ll need to check all tests to make sure that they’re not accidentally changing global state.</p></li>
<li><p>If you use <a href="https://testthat.r-lib.org/articles/test-fixtures.html#package">packaged scope test fixtures</a>, you’ll need to review them to make sure that they work in parallel. For example, if you were previously creating a temporary database in the test directory, you’d need to instead create it in the session temporary directory so that each process gets its own independent version.</p></li>
</ul>
</div>
<div id="performance" class="section level2">
<h2 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h2>
<p>There is some overhead associated with running tests in parallel:</p>
<ul>
<li><p>Startup cost is linear in the number of subprocesses, because we need to create them in a loop. This is about 50ms on my laptop. Each subprocess needs to load testthat and the tested package, this happens in parallel, and we cannot do too much about it.</p></li>
<li><p>Clean up time is again linear in the number of subprocesses, and it about 80ms per subprocess on my laptop.</p></li>
<li><p>It seems that sending a message (i.e. a passing or failing expectation) is about 2ms currently. This is the total cost that includes sending the message, receiving it, and replying it to a non-parallel reporter.</p></li>
</ul>
<p>This overhead generally means that if you have many test files that take a short amount of time, you’re unlikely to see a huge benefit by using parallel tests. For example, testthat itself takes about 10s to run tests in serial, and 8s to run the tests in parallel.</p>
<div id="changing-the-order-of-the-test-files" class="section level3">
<h3 class="hasAnchor">
<a href="#changing-the-order-of-the-test-files" class="anchor"></a>Changing the order of the test files</h3>
<p>By default testthat starts the test files in alphabetical order. If you have a few number of test files that take longer than the rest, then this might not be the best order. Ideally the slow files would start first, as the whole test suite will take at least as much time as its slowest test file. You can change the order with the <code>Config/testthat/start-first</code> option in <code>DESCRIPTION</code>. For example testthat currently has:</p>
<pre><code>Config/testthat/start-first: watcher, parallel*</code></pre>
<p>The format is a comma separated list of glob patterns, see <code><a href="https://rdrr.io/r/utils/glob2rx.html">?utils::glob2rx</a></code>. The matching test files will start first. (The <code>test-</code> prefix is ignored.)</p>
</div>
</div>
<div id="reporters" class="section level2">
<h2 class="hasAnchor">
<a href="#reporters" class="anchor"></a>Reporters</h2>
<div id="default-reporters" class="section level3">
<h3 class="hasAnchor">
<a href="#default-reporters" class="anchor"></a>Default reporters</h3>
<p>See <code><a href="../reference/default_reporter.html">default_reporter()</a></code> for how testthat selects the default reporter for <code>devtools::test()</code> and <code><a href="../reference/test_package.html">testthat::test_local()</a></code>. In short, testthat selects <code>ProgressReporter</code> for non-parallel and <code>ParallelProgressReporter</code> for parallel tests by default. (Other testthat test functions, like <code><a href="../reference/test_package.html">test_check()</a></code>, <code><a href="../reference/test_file.html">test_file()</a></code> , etc. select different reporters by default.)</p>
</div>
<div id="parallel-support" class="section level3">
<h3 class="hasAnchor">
<a href="#parallel-support" class="anchor"></a>Parallel support</h3>
<p>Most reporters support parallel tests. If a reporter is passed to <code>devtools::test()</code>, <code><a href="../reference/test_dir.html">testthat::test_dir()</a></code>, etc. directly, and it does not support parallel tests, then testthat runs the test files sequentially.</p>
<p>Currently the following reporters <em>don’t</em> support parallel tests:</p>
<ul>
<li><p><code>DebugReporter</code>, because it is not currently possible to debug subprocesses.</p></li>
<li><p><code>JunitReporter</code>, because this reporter records timing information for each test block, and this is currently only available for reporters that support multiple active test files. (See “Writing parallel reporters” below.)</p></li>
<li><p><code>LocationReporter</code> because testthat currently does not include location information for successful tests when running in parallel, to minimize messaging between the processes.</p></li>
<li><p><code>StopReporter</code>, as this is a reporter that testthat uses for interactive <code><a href="../reference/expect_that.html">expect_that()</a></code> calls.</p></li>
</ul>
<p>The other built-in reporters all support parallel tests, with some subtle differences:</p>
<ul>
<li><p>Reporters that stop after a certain number of failures can only stop at the end of a test file.</p></li>
<li><p>Reporters report all information about a file at once, unless they support <em>parallel updates</em>. E.g. <code>ProgressReporter</code> does not update its display until a test file is complete.</p></li>
<li>
<p>The standard output and standard error, i.e. <code><a href="https://rdrr.io/r/base/print.html">print()</a></code>, <code><a href="https://rdrr.io/r/base/cat.html">cat()</a></code>, <code><a href="https://rdrr.io/r/base/message.html">message()</a></code>, etc. output from the test files are lost currently. If you want to use <code><a href="https://rdrr.io/r/base/cat.html">cat()</a></code> or <code><a href="https://rdrr.io/r/base/message.html">message()</a></code> for print-debugging test cases, then the best is to temporarily run tests sequentially, by changing the <code>Config</code> entry in <code>DESCRIPTION</code> or selecting a non-parallel reporter, e.g. the <code>CheckReporter</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"badtest"</span>, reporter <span class="op">=</span> <span class="st">"check"</span><span class="op">)</span></code></pre></div>
</li>
</ul>
</div>
<div id="writing-parallel-reporters" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-parallel-reporters" class="anchor"></a>Writing parallel reporters</h3>
<p>To support parallel tests, a reporter must be able to function when the test files run in a subprocess. For example <code>DebugReporter</code> does not support parallel tests, because it requires direct interaction with the frames in the subprocess. When running in parallel, testthat does not provide location information (source references) for test successes.</p>
<p>To support parallel tests, a reporter must set <code>self$capabilities$parallel_support</code> to <code>TRUE</code> in its <code>initialize()</code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">...</span>
<span class="va">initialize</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  <span class="va">self</span><span class="op">$</span><span class="va">capabilities</span><span class="op">$</span><span class="va">parallel_support</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
  <span class="va">...</span>
<span class="op">}</span>
<span class="va">...</span></code></pre></div>
<p>When running in parallel, testthat runs the reporter in the main process, and relays information between the reporter and the test code transparently. (Currently the reporter does not even know that the tests are running in parallel.)</p>
<p>If a reporter does not support parallel updates (see below), then testthat internally caches all calls to the reporter methods from subprocesses, until a test file is complete. This is because these reporters are not prepared for running multiple test files concurrently. Once a test file is complete, testthat calls the reporter’s <code>$start_file()</code> method, relays all <code>$start_test()</code> , <code>$end_test()</code>, <code>$add_result()</code>, etc. calls in the order they came in from the subprocess, and calls <code>$end_file()</code> .</p>
</div>
<div id="parallel-updates" class="section level3">
<h3 class="hasAnchor">
<a href="#parallel-updates" class="anchor"></a>Parallel updates</h3>
<p>The <code>ParallelProgressReporter</code> supports parallel updates. This means that once a message from a subprocess comes in, the reporter is updated immediately. For this to work, a reporter must be able to handle multiple test files concurrently.</p>
<p>A reporter declares parallel update support by setting <code>self$capabilities$parallel_updates</code> to <code>TRUE</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">...</span>
<span class="va">initialize</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  <span class="va">self</span><span class="op">$</span><span class="va">capabilities</span><span class="op">$</span><span class="va">parallel_support</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
  <span class="va">self</span><span class="op">$</span><span class="va">capabilities</span><span class="op">$</span><span class="va">parallel_updates</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
  <span class="va">...</span>
<span class="op">}</span>
<span class="va">...</span></code></pre></div>
<p>For these reporters, testthat does not cache the messages from the subprocesses. Instead, when a message comes in:</p>
<ul>
<li><p>It calls the <code>$start_file()</code> method, letting the reporter know which file the following calls apply to. This means that the reporter can receive multiple <code>$start_file()</code> calls for the same file.</p></li>
<li><p>Then relays the message from the subprocess, calling the appropriate <code>$start_test()</code> , <code>$add_result()</code>, etc. method.</p></li>
</ul>
<p>testthat also calls the new <code>$update()</code> method of the reporter regularly, even if it does not receive any messages from the subprocess. (Currently aims to do this every 100ms, but there are no guarantees.) The <code>$update()</code> method may implement a spinner to let the user know that the tests are running.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
