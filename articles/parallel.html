<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running tests in parallel • testthat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running tests in parallel">
<meta property="og:description" content="testthat">
<meta property="og:image" content="https://testthat.r-lib.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testthat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.99.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/custom-expectation.html">Custom expectations</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running tests in parallel</a>
    </li>
    <li>
      <a href="../articles/skipping.html">Skipping tests</a>
    </li>
    <li>
      <a href="../articles/snapshotting.html">Snapshot tests</a>
    </li>
    <li>
      <a href="../articles/test-fixtures.html">Test fixtures</a>
    </li>
    <li>
      <a href="../articles/third-edition.html">testthat 3e</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/">Version 2.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/testthat-2-1-0/">Version 2.1.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2017/12/testthat-2-0-0/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2016/04/29/testthat-1-0-0/">Version 1.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2015/05/29/testthat-0-10-0/">Version 0.10.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2014/09/23/testthat-0-9/">Version 0.9.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/testthat/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="parallel_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running tests in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/testthat/blob/master/vignettes/parallel.Rmd"><code>vignettes/parallel.Rmd</code></a></small>
      <div class="hidden name"><code>parallel.Rmd</code></div>

    </div>

    
    
<div id="parallel-testthat-preview" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel-testthat-preview" class="anchor"></a>Parallel testthat (preview)</h2>
<div id="turning-on-parallel-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#turning-on-parallel-tests" class="anchor"></a>Turning on parallel tests</h3>
<p>The current development version of testthat supports running test in parallel, in multiple R subprocesses. To turn on this feature, you need to set the <code>TESTTHAT_PARALLEL</code> environment variable to <code>true</code>.</p>
</div>
<div id="number-of-parallel-subprocesses" class="section level3">
<h3 class="hasAnchor">
<a href="#number-of-parallel-subprocesses" class="anchor"></a>Number of parallel subprocesses</h3>
<p>The number of subprocesses is taken from the <code>Ncpus</code> option, if set, otherwise it is fixed to 4. This will change later, see the TODO list at <a href="https://github.com/r-lib/testthat/pull/1032" class="uri">https://github.com/r-lib/testthat/pull/1032</a>. (But testthat never starts more subprocesses than the number of test files.)</p>
</div>
<div id="test-files-test-order-and-state" class="section level3">
<h3 class="hasAnchor">
<a href="#test-files-test-order-and-state" class="anchor"></a>Test files, test order and state</h3>
<p>testthat starts running the test files in alphabetical order. As soon as a subprocess has finished with a file, it receives another file to run from the main process, until all files are done. In general, the user cannot make any assumptions about the order of the files, and which subprocess they’ll be executed on.</p>
<p>Test files do not start in a clean R process currently. The first <em>n</em> files, where <em>n</em> is the number of subprocesses, do start in a clean R process, but users should not rely on that. In particular, options (set via <code><a href="https://rdrr.io/r/base/options.html">options()</a></code> or otherwise) are <em>not</em> reset, loaded packages are <em>not</em> unloaded, the global environment is <em>not</em> cleared, etc. In the future the user will be able to request a clean R process for a test file, see the TODO at <a href="https://github.com/r-lib/testthat/pull/1032" class="uri">https://github.com/r-lib/testthat/pull/1032</a> .</p>
<p>Since files run in alphabetical order, ideally the files that take the longest to run, should be started first. This way, we can avoid starting a long running test file on a subprocess, when the other files have finished already and the other subprocesses have nothing to do. To achive this, you can name your test files like this:</p>
<pre><code>test-1-slowest.R
test-2-next-slowest.R
...</code></pre>
</div>
<div id="helper-setup-teardown-files" class="section level3">
<h3 class="hasAnchor">
<a href="#helper-setup-teardown-files" class="anchor"></a>Helper, setup, teardown files</h3>
<p>All test subprocesses run the helper files (if requested in <code>devtools::test()</code>, <code><a href="../reference/test_dir.html">testthat::test_dir()</a></code>, etc.), then they run the setup files. After the last test file has finished, all subprocesses run the teardown files.</p>
</div>
<div id="known-issues" class="section level3">
<h3 class="hasAnchor">
<a href="#known-issues" class="anchor"></a>Known issues</h3>
<ul>
<li>The <code>location</code> reporter does not work currently. Any reporter that relies on stack traces being present in all test results, will fail.</li>
<li>The current reporters are not ideal for parallel execution, as they cannot handle running multiple files at the same time. Parallel testthat tricks the reporters by collecting all results for a test file, and then “replaying” them at once. Reporters can not show the progress within files. This will be fixed later.</li>
<li>testthat does not handle crashes currently. This will be fixed later.</li>
<li>You cannot currently use the <code>env</code> argument of <code><a href="../reference/test_dir.html">test_dir()</a></code>, etc. Do not set this argument if you use parallel testthat. This will be fixed later.</li>
<li>Test files that perform many quick expectations might be slow. This will be fixed later.</li>
<li>testthat does not currently auto-detect the number of processors. This will be fixed later.</li>
<li>Parallel testhat currently silently ignores failures in the helper, startup and teardown files. This will be fixed later.</li>
<li>The process tree cleanup only works on macOS, Windows and Linux currently, so parallel testthat only supports these operating systems. This will be fixed later.</li>
<li>testthat cannot yet run its own tests in parallel.</li>
<li>covr might not work for parallel tests, at least it fails for testthat itself.</li>
</ul>
</div>
<div id="benchmarks" class="section level3">
<h3 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>Benchmarks</h3>
<p>These are very preliminary, to have a feeling where the bottlenecks might be.</p>
<div id="startup-time" class="section level4">
<h4 class="hasAnchor">
<a href="#startup-time" class="anchor"></a>Startup time</h4>
<p>Startup cost is linear in the number of subprocesses, because we need to create them in a loop. This is about 50ms on my laptop. Each subprocess needs to load testthat and the tested package, this happens in parallel, and we cannot do too much about it.</p>
</div>
<div id="cleanup-time" class="section level4">
<h4 class="hasAnchor">
<a href="#cleanup-time" class="anchor"></a>Cleanup time</h4>
<p>This is again linear in the number of subprocesses, and it about 80ms per subprocess on my laptop. The teardown files run in parallel, of course.</p>
</div>
<div id="messaging-costs" class="section level4">
<h4 class="hasAnchor">
<a href="#messaging-costs" class="anchor"></a>Messaging costs</h4>
<p>To get a sense of messaging costs, I run 1-8 extremely simple test files:</p>
<pre><code><a href="../reference/test_that.html">test_that("foobar", {
  for (i in 1:100) expect_true(TRUE)
})</a></code></pre>
<p>with changing the number of expectations and number of subprocesses. It seems that sending a message is about 2ms currently. This is the total cost that includes sending the message, receiving it, and replying it to a non-parallel reporter. We will improve this by avoiding frequent messages in a single subprocess and sending them in batches. This will make sure that test suites that have hundreds or thousands of expectations will not lose much.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
